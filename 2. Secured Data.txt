---------------- CREATE TAG --------------------------------------------
CREATE OR REPLACE TAG DEV_DB_FINANCE.SCH_FINANCE_STG.TAG_ENCRYPTION;

------------------- CREATE MASKING POLICY ------------------------------------
CREATE or REPLACE MASKING POLICY DEV_DB_FINANCE.SCH_FINANCE_STG.ENCRYPTION_POLICY as (val string) RETURNS STRING
 ->
  CASE
    when SYSTEM$GET_TAG( 'DEV_DB_FINANCE.SCH_FINANCE_STG.TAG_ENCRYPTION' , CURRENT_ROLE() , 'ROLE' )='ENCRYPTED' then val
    ELSE to_varchar(decrypt(TO_BINARY(val), 'TWFza21lYXNpYW1wYXlyb2xsZGF0YQ==') ,'utf-8')
  END;
  
------------------- ASSIGN MASKING PLOICY TO COLUMNS ----------------------------------------
ALTER TABLE DEV_DB_FINANCE.SCH_FINANCE_STG.TBL_SALARY MODIFY COLUMN GROSS_SAL SET TAG DEV_DB_FINANCE.SCH_FINANCE_STG.TAG_ENCRYPTION='ENCRYPTED';
ALTER TABLE DEV_DB_FINANCE.SCH_FINANCE_STG.TBL_SALARY MODIFY COLUMN INCENTIVE SET TAG DEV_DB_FINANCE.SCH_FINANCE_STG.TAG_ENCRYPTION='ENCRYPTED';
ALTER TABLE DEV_DB_FINANCE.SCH_FINANCE_STG.TBL_SALARY MODIFY COLUMN TAX SET TAG DEV_DB_FINANCE.SCH_FINANCE_STG.TAG_ENCRYPTION='ENCRYPTED';
ALTER TABLE DEV_DB_FINANCE.SCH_FINANCE_STG.TBL_SALARY MODIFY COLUMN TOTAL_SALARY SET TAG DEV_DB_FINANCE.SCH_FINANCE_STG.TAG_ENCRYPTION='ENCRYPTED';

------------------- ASSIGN MASKING PLOICY TO TAG ----------------------------------------
ALTER TAG DEV_DB_FINANCE.SCH_FINANCE_STG.TAG_ENCRYPTION SET MASKING POLICY DEV_DB_FINANCE.SCH_FINANCE_STG.ENCRYPTION_POLICY;

----------------CREATE USER AND ROLE---- Encrypted user----------------------------------------
CREATE OR REPLACE USER USR_ENCRYPTED_ACCESS PASSWORD='Password!1' MUST_CHANGE_PASSWORD =FALSE;
CREATE OR REPLACE ROLE RL_ENCRYPTED_ACCESS TAG (DEV_DB_FINANCE.SCH_FINANCE_STG.TAG_ENCRYPTION='ENCRYPTED');
GRANT USAGE ON WAREHOUSE  COMPUTE_WH TO ROLE RL_ENCRYPTED_ACCESS;
GRANT ROLE RL_ENCRYPTED_ACCESS TO USER USR_ENCRYPTED_ACCESS;
GRANT USAGE ON DATABASE DEV_DB_FINANCE TO ROLE RL_ENCRYPTED_ACCESS;
GRANT USAGE ON SCHEMA DEV_DB_FINANCE.SCH_FINANCE_STG TO ROLE RL_ENCRYPTED_ACCESS;
GRANT ALL ON ALL TABLES IN SCHEMA DEV_DB_FINANCE.SCH_FINANCE_STG TO ROLE RL_ENCRYPTED_ACCESS;

----------------CREATE USER AND ROLE---- payroll Admin user----------------------------------------
CREATE OR REPLACE USER USR_PAYROLL_ADMIN PASSWORD='Password!1' MUST_CHANGE_PASSWORD =FALSE;
CREATE OR REPLACE ROLE RL_PAYROLL_ADMIN TAG (DEV_DB_FINANCE.SCH_FINANCE_STG.TAG_ENCRYPTION='NON-ENCRYPTED');
GRANT USAGE ON WAREHOUSE  COMPUTE_WH TO ROLE RL_PAYROLL_ADMIN;
GRANT ROLE RL_PAYROLL_ADMIN TO USER USR_PAYROLL_ADMIN;
GRANT USAGE ON DATABASE DEV_DB_FINANCE TO ROLE RL_PAYROLL_ADMIN;
GRANT USAGE ON SCHEMA DEV_DB_FINANCE.SCH_FINANCE_STG TO ROLE RL_PAYROLL_ADMIN;
GRANT ALL ON ALL TABLES IN SCHEMA DEV_DB_FINANCE.SCH_FINANCE_STG TO ROLE RL_PAYROLL_ADMIN;

