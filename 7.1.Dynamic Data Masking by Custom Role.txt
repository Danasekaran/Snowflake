CREATE OR REPLACE USER USR_SALESADMIN PASSWORD='Password!1' MUST_CHANGE_PASSWORD =FALSE;
CREATE OR REPLACE ROLE RL_SALES_ADMIN;
GRANT USAGE ON WAREHOUSE  COMPUTE_WH TO ROLE RL_SALES_ADMIN;
GRANT ROLE RL_SALES_ADMIN TO USER USR_SALESADMIN;
GRANT USAGE ON DATABASE DEV_DB_SALES TO ROLE RL_SALES_ADMIN;
GRANT USAGE ON SCHEMA DEV_DB_SALES.SCH_SALES_STG TO ROLE RL_SALES_ADMIN;
GRANT ALL ON ALL TABLES IN SCHEMA DEV_DB_SALES.SCH_SALES_STG TO ROLE RL_SALES_ADMIN;
GRANT ROLE RL_SALES_ADMIN TO ROLE sysadmin;


CREATE OR REPLACE USER USR_ANALYTICS PASSWORD='Password!1' MUST_CHANGE_PASSWORD =FALSE;
CREATE OR REPLACE ROLE RL_ANALYTICS_ADMIN;
GRANT USAGE ON WAREHOUSE  COMPUTE_WH TO ROLE RL_ANALYTICS_ADMIN;
GRANT ROLE RL_ANALYTICS_ADMIN TO USER USR_ANALYTICS;
GRANT USAGE ON DATABASE DEV_DB_SALES TO ROLE RL_ANALYTICS_ADMIN;
GRANT USAGE ON SCHEMA DEV_DB_SALES.SCH_SALES_STG TO ROLE RL_ANALYTICS_ADMIN;
GRANT ALL ON ALL TABLES IN SCHEMA DEV_DB_SALES.SCH_SALES_STG TO ROLE RL_ANALYTICS_ADMIN;
GRANT ROLE RL_ANALYTICS_ADMIN TO ROLE sysadmin;


CREATE OR REPLACE MASKING POLICY MASK_SALES_AMOUNT AS (val NUMBER) RETURNS NUMBER ->
  CASE
    WHEN CURRENT_ROLE() ='RL_ANALYTICS_ADMIN' THEN '0000000.00'
    ELSE val
  END;

  
alter table DEV_DB_SALES.SCH_SALES_STG.TBL_MONTHLY_SALES modify column SALES_AMOUNT 
set masking policy MASK_SALES_AMOUNT;

-- alter table DEV_DB_SALES.SCH_SALES_STG.TBL_MONTHLY_SALES modify column SALES_AMOUNT 
-- unset masking policy;



select * from  DEV_DB_SALES.SCH_SALES_raw.TBL_MONTHLY_SALES;

--insert into DEV_DB_SALES.SCH_SALES_raw.TBL_MONTHLY_SALES values('2','202311',sysdate(),200)